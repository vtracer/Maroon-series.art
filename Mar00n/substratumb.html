<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Substratum — Transition</title>
  <meta name="description" content="Transitioning to maintenance chapter." />
  <script defer src="js/maroon-glitch.js"></script>
  <style>
    :root{--bg:#0b0204;--accent:#ff9f4a;--muted:#e9e0d9}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--muted);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2.5rem;padding-bottom:200vh}
    .pane{width:100%;max-width:980px;background:rgba(0,0,0,0.36);border-radius:10px;padding:20px;border:1px solid rgba(255,159,74,0.04);box-shadow:0 20px 60px rgba(0,0,0,0.6)}
    .meta{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .badge{background:var(--accent);color:#1b0002;padding:.3rem .6rem;border-radius:6px;font-weight:800}
    .title{font-weight:800;font-size:1.1rem}

    .terminal{height:56vh;overflow:auto;padding:12px;background:linear-gradient(180deg, rgba(0,0,0,0.2), rgba(0,0,0,0.06));border-radius:8px;border:1px solid rgba(255,255,255,0.02);}
    .terminal::-webkit-scrollbar{display:none}
    .terminal{-ms-overflow-style:none;scrollbar-width:none}
    .line{color:var(--accent);white-space:pre-wrap;font-size:0.95rem;line-height:1.45;margin:0 0.125rem}
    .line.info{color:#9fdff5}
    .line.warn{color:#ffdca3}

    /* Animated background & effects */
    .pane{background:linear-gradient(160deg, rgba(32,4,6,0.45), rgba(6,4,10,0.55));background-size:200% 200%;animation: pan 9s linear infinite}
    @keyframes pan{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .binary-rain{position:absolute;inset:0;pointer-events:none;overflow:hidden;border-radius:10px}
    .binary-char{position:absolute;color:rgba(255,160,80,0.06);font-family:ui-monospace,monospace;font-size:12px;will-change:transform,opacity;mix-blend-mode:screen}

    .title.glitch{position:relative}
    .title.glitch::after{content:attr(data-text);position:absolute;left:2px;top:0;color:rgba(255,200,120,0.12);clip-path:inset(0 0 60% 0);transform:translateX(-2px);}
    @keyframes shimmer{0%{opacity:0.85;filter:brightness(0.98)}50%{opacity:1;filter:brightness(1.06)}100%{opacity:0.95;filter:brightness(0.98)}}
    .title{animation: shimmer 3s ease-in-out infinite}

    .overlay{position:fixed;inset:0;pointer-events:none;background:radial-gradient(circle at 20% 20%, rgba(255,159,74,0.06), transparent 12%), radial-gradient(circle at 80% 80%, rgba(212,0,0,0.03), transparent 18%);opacity:0;transition:opacity 480ms linear}
    .overlay.active{opacity:1}

    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    a.btn{padding:.45rem .7rem;border-radius:6px;background:var(--accent);color:#1b0002;text-decoration:none;font-weight:800}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    @media (prefers-reduced-motion: reduce){ .overlay{transition:none} }
    @media (prefers-reduced-motion: reduce){
      .pane{animation:none}
      .title{animation:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="pane" role="main" aria-labelledby="h">
      <div id="term" class="terminal" role="log" aria-live="polite" tabindex="0"></div>
      <div id="binary" class="binary-rain" aria-hidden="true"></div>

      <div class="meta" style="margin-top:12px">
        <div class="badge">TRANSFER</div>
        <div class="title" id="h">Substratum → Maintenance</div>
        <div style="margin-left:auto;color:rgba(233,224,217,0.7);font-weight:700">Target: maintenance.html</div>
      </div>

      <div class="actions">
      </div>

      <div id="reducedTip" style="display:none;margin-top:8px;color:rgba(233,224,217,0.85)">Reduced motion is enabled — use the link above to continue.</div>
      <div id="announcer" class="sr-only" aria-live="assertive"></div>
    </section>
  </div>

  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <script>
  (function(){
    const target = '/Maroon-series.art/Mar00n/maintenance/maintenance.html';
    const term = document.getElementById('term');
    const overlay = document.getElementById('overlay');
    const announcer = document.getElementById('announcer');
    const reduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const binaryRoot = document.getElementById('binary');
    // spotlight wash elements
    const spotlightRoot = document.createElement('div');
    spotlightRoot.id = 'spotlights';
    spotlightRoot.style.position = 'fixed';
    spotlightRoot.style.inset = '0';
    spotlightRoot.style.pointerEvents = 'none';
    spotlightRoot.style.zIndex = '10010';
    document.body.appendChild(spotlightRoot);
    const whiteWash = document.createElement('div');
    whiteWash.id = 'whiteWash';
    whiteWash.style.position = 'fixed';
    whiteWash.style.inset = '0';
    whiteWash.style.background = 'rgba(255,255,255,0)';
    whiteWash.style.pointerEvents = 'none';
    whiteWash.style.zIndex = '10011';
    document.body.appendChild(whiteWash);

    function announce(t){ announcer.textContent = t; }

    if(reduced){ document.getElementById('reducedTip').style.display='block'; announce('Reduced motion enabled. Use Proceed Now link.'); return; }

    const seedLines = [
      'HANDSHAKE: ESTABLISHED',
      'SESSION ID: ' + Math.floor(Math.random()*900000 + 100000),
      'CHECKPOINT: mirror->maintenance',
      'SYNC: clock drift normal',
      'LOCK: file-system write lock acquired',
      'ENCRYPTION: TLS-AES-GCM OK',
      'STACK: preparing transfer buffer',
      'THROTTLE: adaptive',
      'LATENCY: stable',
      'STREAM: priming channels',
    ];

    const liveFeed = [
      'fragment: header.bin sent',
      'fragment: assets pack 03 queued',
      'mirror: content shard 7 of 7',
      'verify: checksum OK',
      'commit: staging -> maintenance',
      'notify: watchers/feeds updated',
      'finalizing: small delay to ensure integrity'
    ];

    let index = 0, liveIndex = 0;
    let interval = 750;

    function append(text, cls){
      const el = document.createElement('div'); el.className = 'line' + (cls? ' '+cls:''); el.textContent = text; term.appendChild(el); term.scrollTop = term.scrollHeight; }

    function ramp(){
      if (index < seedLines.length) append(seedLines[index++]);
      else append('> ' + liveFeed[liveIndex++ % liveFeed.length]);
      // accelerate slightly until a cap
      interval = Math.max(40, Math.floor(interval * 0.82));
      // adjust overlay intensity based on how far we've gone
      const prog = Math.min(1, (750 - interval) / 700);
      if (prog > 0.06) overlay.classList.add('active');
      overlay.style.opacity = Math.min(0.96, prog*0.9).toFixed(3);
      // Keep scrolling indefinitely until redirect
      setTimeout(ramp, interval);
    }

    // Binary rain generator (lightweight) — respects reduced motion
    function spawnBinary(){
      if (reduced || !binaryRoot) return;
      const x = Math.random() * 100;
      const ch = Math.random() > 0.5 ? '1' : '0';
      const el = document.createElement('div'); el.className='binary-char'; el.textContent = ch;
      el.style.left = x + '%'; el.style.top = '-4%'; el.style.opacity = (0.03 + Math.random()*0.18).toFixed(3);
      const size = 10 + Math.random()*14; el.style.fontSize = size + 'px';
      binaryRoot.appendChild(el);
      const dur = 2800 + Math.random()*4200;
      el.animate([{transform:'translateY(0) rotate(0deg)' , opacity: el.style.opacity},{transform:'translateY(110vh) rotate(90deg)', opacity:0}], {duration: dur, easing:'cubic-bezier(.22,.9,.3,1)'});
      setTimeout(()=> el.remove(), dur+80);
    }
    const binInterval = setInterval(()=> spawnBinary(), 220);
    if (reduced) clearInterval(binInterval);
    let whiteProgress = 0; // 0..1
    let spotInterval = null;
    function spawnSpotlight(){
      if (reduced) return;
      const s = document.createElement('div');
      s.className = 'spotlight';
      const x = Math.random() * 100; const y = Math.random() * 100;
      const size = 160 + Math.random() * 600; // px
      s.style.position = 'absolute';
      s.style.left = x + '%'; s.style.top = y + '%';
      s.style.width = size + 'px'; s.style.height = size + 'px';
      s.style.transform = 'translate(-50%,-50%) scale(1)';
      s.style.borderRadius = '50%';
      s.style.background = 'radial-gradient(circle at 50% 40%, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.75) 30%, rgba(255,255,255,0.28) 60%, rgba(255,255,255,0) 100%)';
      s.style.opacity = (0.35 + Math.random()*0.4).toFixed(3);
      s.style.mixBlendMode = 'screen';
      s.style.pointerEvents = 'none';
      // persistent: do not remove
      spotlightRoot.appendChild(s);

      // small pop-in animation then settle (non-destructive)
      try{
        s.animate([
          { transform: 'translate(-50%,-50%) scale(0.6)', opacity: 0 },
          { transform: 'translate(-50%,-50%) scale(1.02)', opacity: s.style.opacity }
        ], { duration: 420 + Math.random()*300, easing: 'cubic-bezier(.2,.9,.2,1)', fill: 'forwards' });
      }catch(e){}

      // increment white wash slowly so spotlights must accumulate
      whiteProgress = Math.min(1, whiteProgress + (0.02 + Math.random()*0.035));
      whiteWash.style.background = 'rgba(255,255,255,' + (whiteProgress).toFixed(3) + ')';

      // if white enough, stop spawning and finish
      if (whiteProgress >= 0.995){
        if (spotInterval) clearInterval(spotInterval);
        setTimeout(()=> finish(), 180);
      }
    }

    function startSpotlights(){
      if (reduced) return finish();
      // begin slower, then accelerate so spotlights build up over time
      let delay = 1200; // start slower (longer initial pause)
      function loop(){
        spawnSpotlight();
        // accelerate gradually but keep a reasonable floor so accumulation isn't instant
        delay = Math.max(300, Math.floor(delay * 0.9));
        setTimeout(loop, delay);
      }
      loop();
    }

    function finish(){
      announce('Transfer complete. Redirecting to maintenance.');
      console.debug('[substratumb] finish() called');
      try{
        const targetPath = 'maintenance/maintenance.html';
        if (window.__maroonGlitch && typeof window.__maroonGlitch.triggerTransition === 'function'){
          console.debug('[substratumb] finish() using glitch API with', targetPath);
          window.__maroonGlitch.triggerTransition({ duration: 4200, target: targetPath });
        } else {
          console.debug('[substratumb] finish() direct redirect to', targetPath);
          window.location.href = targetPath;
        }
      }catch(e){ 
        console.error('[substratumb] finish() error:', e);
        window.location.href = 'maintenance/maintenance.html';
      }
    }

    // Start streaming lines
    setTimeout(ramp, 420);

    // Start spotlights immediately so they begin at page load
    startSpotlights();

    // Scroll-down transition: if user scrolls to the bottom, trigger a glitchy exit
    (function(){
      if (reduced) { console.debug('[substratumb] reduced-motion active — scroll trigger disabled'); return; } // respect reduced motion
      let triggered = false;

      // Check if user has scrolled to bottom of page
      window.addEventListener('scroll', function(){
        if (triggered) return;
        
        const scrollPos = window.innerHeight + window.scrollY;
        const docHeight = document.documentElement.scrollHeight;
        const scrollPercent = (scrollPos / docHeight) * 100;
        
        console.debug('[substratumb] scroll pos:', scrollPos, 'doc height:', docHeight, 'percent:', scrollPercent.toFixed(1) + '%');
        
        // trigger when user has scrolled to 90% of page or within 100px of bottom
        if (scrollPercent >= 90 || scrollPos >= docHeight - 100){
          triggered = true;
          console.debug('[substratumb] bottom reached — initiating transition');
          
          try{
            const targetPath = 'maintenance/maintenance.html';
            console.debug('[substratumb] redirecting to:', targetPath);
            
            // Try glitch API first
            if (window.__maroonGlitch && typeof window.__maroonGlitch.triggerTransition === 'function'){
              console.debug('[substratumb] using glitch API');
              window.__maroonGlitch.triggerTransition({ duration: 4200, target: targetPath });
            } else {
              console.debug('[substratumb] no glitch API available, direct redirect');
            }
            
            // Guaranteed fallback redirect after a short delay
            setTimeout(()=>{
              console.debug('[substratumb] executing fallback redirect');
              window.location.href = targetPath;
            }, 1000);
          }catch(e){ 
            console.error('[substratumb] transition error:', e);
            window.location.href = 'maintenance/maintenance.html';
          }
        }
      }, { passive: true });
    })();

    // Keyboard: Enter proceeds immediately
    window.addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter'){ ev.preventDefault(); finish(); } });

    // no direct proceed control; fallback link removed

    // ensure terminal receives focus when clicked
    term.addEventListener('click', ()=> term.focus());
    // small visual flourish: occasional title glitch pulse
    setInterval(()=>{
      const el = document.getElementById('h'); if(!el || reduced) return; el.classList.add('glitch'); setTimeout(()=> el.classList.remove('glitch'), 420);
    }, 3400 + Math.random()*2200);
  })();
  </script>
</body>
</html>
